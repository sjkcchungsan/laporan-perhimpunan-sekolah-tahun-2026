<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Laporan SJKC Chung San</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 10px; }
        .container { display: flex; flex-direction: column; gap: 20px; }
        @media (min-width: 992px) {
            .container { flex-direction: row; align-items: flex-start; }
            .form-area { width: 35%; position: sticky; top: 10px; max-height: 95vh; overflow-y: auto; }
            .preview-area { width: 65%; }
        }
        .form-area { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        label { font-weight: bold; display: block; margin-top: 15px; font-size: 0.9rem; }
        input, textarea, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn-blue { background-color: #3498db; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; flex: 1; font-weight: bold; }
        .btn-green { background-color: #27ae60; color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; cursor: pointer; font-size: 1.1rem; font-weight: bold; margin-top: 25px; }
        .preview-area { background: #555; padding: 10px; overflow-x: auto; display: flex; justify-content: center; }
        #pdf-content { background: white; width: 210mm; min-height: 297mm; padding: 10mm 15mm; box-sizing: border-box; margin: 0; flex-shrink: 0; }
        .logo-box { text-align: center; margin: 0 0 5px 0; }
        .logo-box img { max-width: 100px; height: auto; }
        h2 { text-align: center; text-decoration: underline; font-size: 18px; margin: 0 0 15px 0; text-transform: uppercase; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; border: 1px solid black; }
        th, td { border: 1px solid black; padding: 8px; font-size: 13px; word-wrap: break-word; vertical-align: top; }
        th { background-color: #f2f2f2; width: 35%; text-align: left; }
        .photo-page { page-break-before: always; text-align: center; padding-top: 10mm; }
        .photo-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 15px; }
        .img-wrapper { width: 45%; border: 1px solid #000; padding: 5px; background: #fff; box-sizing: border-box; }
        .img-wrapper img { width: 100%; height: 200px; object-fit: contain; display: block; }
    </style>
</head>
<body>

<div class="container">
    <div class="form-area">
        <h3 style="margin:0; color:#2c3e50;">Input Laporan</h3>
        <label>Tarikh</label><input type="text" id="tarikh" placeholder="12 Januari 2026">
        <label>Hari</label><input type="text" id="hari" placeholder="Isnin">
        <label>Masa Mula</label><input type="text" id="masa" placeholder="0940">
        <label>Senarai Staf (Multi-select)</label>
        <select id="staf" multiple size="8"></select>
        <div class="btn-group">
            <button type="button" class="btn-blue" onclick="selectAllStaf()">Pilih Semua</button>
            <button type="button" class="btn-blue" style="background-color:#95a5a6" onclick="clearStaf()">Reset</button>
        </div>
        <label>Tema Sivik</label><input type="text" id="tema">
        <label>Nama Pengacara</label><input type="text" id="pengacara">
        <label>Ucapan Guru Besar</label><textarea id="gb"></textarea>
        <label>Ucapan GPK Pentadbiran</label><textarea id="gpk_admin"></textarea>
        <label>Ucapan GPK HEM</label><textarea id="gpk_hem"></textarea>
        <label>Ucapan GPK Kokurikulum</label><textarea id="gpk_koku"></textarea>
        <label>Ucapan Staf Lain</label><textarea id="staf_lain"></textarea>
        <label>Disediakan Oleh</label><input type="text" id="disediakan">
        <label>Muat Naik Gambar</label><input type="file" id="inputPhotos" accept="image/*" multiple>
        <button id="btnJana" class="btn-green" onclick="generatePDF()">MUAT TURUN & SIMPAN KE DRIVE</button>
    </div>

    <div class="preview-area">
        <div id="pdf-content">
            <div class="logo-box"><img src="logo.png" alt="Logo"></div>
            <h2>LAPORAN PERHIMPUNAN MINGGUAN</h2>
            <table>
                <tr><th>Tarikh</th><td id="pvTarikh"></td></tr>
                <tr><th>Hari</th><td id="pvHari"></td></tr>
                <tr><th>Masa Mula</th><td id="pvMasa"></td></tr>
                <tr><th>Kehadiran Guru/Staf</th><td id="pvStaf"></td></tr>
                <tr><th>Tema Sivik</th><td id="pvTema"></td></tr>
                <tr><th>Nama Pengacara</th><td id="pvPengacara"></td></tr>
                <tr><th>Ucapan Guru Besar</th><td id="pvGB"></td></tr>
                <tr><th>Ucapan GPK Pentadbiran</th><td id="pvGPKAdmin"></td></tr>
                <tr><th>Ucapan GPK HEM</th><td id="pvGPKHEM"></td></tr>
                <tr><th>Ucapan GPK Kokurikulum</th><td id="pvGPKKoku"></td></tr>
                <tr><th>Ucapan Staf Lain</th><td id="pvStafLain"></td></tr>
                <tr><th>Disediakan Oleh</th><td id="pvDisediakan"></td></tr>
                <tr><th>Disahkan Oleh</th><td><strong>Ling Lee Ann</strong><br>Guru Besar SJK(C) Chung San</td></tr>
            </table>
            <div id="photo-area" class="photo-page">
                <h3 style="text-decoration: underline; font-size: 16px;">LAMPIRAN GAMBAR</h3>
                <div id="pvPhotos" class="photo-grid"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // MASUKKAN URL BARU ANDA DI SINI
    const WEB_APP_URL = 'MASUKKAN_URL_BARU_DI_SINI';

    const stafList = ["Ling Lee Ann","Kong Zhe Fong","Fong Cui Fung","Cynthia Ting Xing Rou","Florence Wong Zhi Yu","Goh Su Ching","Lau Yun Hee","Roland Ting Hock Sing","Sharmaine Daphne Anak Slyvester Bakar","Stephen Hii Yii Nan","Tu Hiong Hiong","Unice Wong Wen Wen","Zafrullah Bin Mohd Sabri","Wong Chui Ling","Claudia Mo Ong Yi","Evy Law Jia Jia","Yuki Ng Jiajing","Wee Chun Yang","Efira Nazation Anak Kennedy","Faizah Binti Othman","Mariani Binti Haili","Stacy Wan"];
    const select = document.getElementById('staf');
    stafList.sort().forEach(s => select.add(new Option(s, s)));

    function selectAllStaf() { Array.from(select.options).forEach(o => o.selected = true); updatePreview(); }
    function clearStaf() { Array.from(select.options).forEach(o => o.selected = false); updatePreview(); }

    function updatePreview() {
        const fields = ['tarikh','hari','masa','tema','pengacara','gb','gpk_admin','gpk_hem','gpk_koku','staf_lain','disediakan'];
        fields.forEach(id => {
            const target = 'pv' + id.charAt(0).toUpperCase() + id.slice(1).replace('_','');
            const el = document.getElementById(target);
            if(el) el.innerText = document.getElementById(id).value || '-';
        });
        const sel = Array.from(select.selectedOptions).map(o => o.value);
        document.getElementById('pvStaf').innerText = sel.length ? sel.join(", ") : "-";
    }

    document.querySelectorAll('input, textarea, select').forEach(el => el.addEventListener('input', updatePreview));

    // FUNGSI RESIZE GAMBAR (PENTING UNTUK TELEFON)
    async function processImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const max_size = 800; 
                    if (width > height) { if (width > max_size) { height *= max_size / width; width = max_size; } }
                    else { if (height > max_size) { width *= max_size / height; height = max_size; } }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    document.getElementById('inputPhotos').addEventListener('change', async function(e) {
        const container = document.getElementById('pvPhotos');
        container.innerHTML = 'Memproses Gambar...';
        const files = Array.from(e.target.files);
        let html = '';
        for (let i = 0; i < files.length; i++) {
            const dataUrl = await processImage(files[i]);
            html += `<div class="img-wrapper"><img src="${dataUrl}"><p style="font-size:11px; margin:5px 0;">Gambar ${i+1}</p></div>`;
        }
        container.innerHTML = html;
    });

    async function generatePDF() {
        const btn = document.getElementById('btnJana');
        const fileName = `Laporan_${document.getElementById('tarikh').value || 'Baru'}.pdf`;
        btn.innerText = "Menjana & Menghantar...";
        btn.disabled = true;

        try {
            const element = document.getElementById('pdf-content');
            const opt = {
                margin: 0, filename: fileName, image: { type: 'jpeg', quality: 0.8 },
                html2canvas: { scale: 1.5, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            const pdfWorker = html2pdf().set(opt).from(element);
            const pdfBase64 = await pdfWorker.outputPdf('datauristring');
            
            // Muat turun lokal
            await pdfWorker.save();

            // Hantar ke Drive
            await fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ pdf: pdfBase64, filename: fileName })
            });

            alert("BERJAYA!\n1. Fail dimuat turun.\n2. Fail dihantar ke Google Drive.");

        } catch (error) {
            alert("Ralat: " + error);
        } finally {
            btn.innerText = "MUAT TURUN & SIMPAN KE DRIVE";
            btn.disabled = false;
        }
    }
    window.onload = updatePreview;
</script>
</body>
</html>
